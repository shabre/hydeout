---
layout: post
title: elastic search 데이터 집계
categories:
    - elastic search
excerpt_separator: "<!--more-->"
---

# 집계

## 엘라스틱서치와 데이터분석

일반적인 통계 프로그램은 배치 방식으로 데이터를 처리한다. 대용량 데이터를 하둡이나 RDBMS에 저장하고 배치로 처리하는 방식이다. 반면 엘라스틱서치는 많은양의 데이터를 조각내어 관리한다. 그 덕분에 문서의 수가 늘어나도 배치 처리보다 실시간에 가깝게 문서를 처리할 수 있다.


일반적인 SQL과 엘라스틱서치의 Query DSL 을 비교하면 아래와 같다.

```
SELECT SUM(ratings) FROM movie_review GROUP BY movie_no;
```
이를 엘라스틱서치로 표현하면 아래와 같다.
```json
{
  "aggs":{
    "movie_no_agg":{
      "terms":{
        "field":"movie_no"
      
      },
      "aggs":{
        "ratings_agg":{
          "sum":{
            "field":"ratings"
          }
        }
      }
    }
  }
}
```

## 엘라스틱서치가 집계에 사용하는 기술

데이터를 분석하는데 있어 집계는 검색보다 더 많은 리소스를 사용한다. 

### 캐시

집계 쿼리로 값을 조회하면 마스터 노드가 여러 노드에 있는 데이터를 집계해 질의에 답변한다. 데이터의 양이 클수록 많은 양의 CPU와 메모리 자원이 소모된다. 엘라스틱서치에서는 자체 캐시를 제공하여 이러한 문제를 어느정도 해결해준다. 질의의 결과를 캐시에 두고 같은 질의에 대한 결과는 캐시에서 반환한다. 캐시를 적용하는 것만으로 인덱스의 성능을 대폭 향상시킬 수 있다. 일반적으로 메모리 크기의 1%를 할당하고 설정에서 변경 가능하다.

엘라스틱서치에서는 3가지의 캐시를 제공한다.

### Node query Cache
노드의 모든 샤드가 공유하는 LRU 캐시이다. 캐시 용량이 가득차면 사용량이 가장 적은 데이터를 삭제하고 새로운 결과를 캐싱한다. 기본적으로 10%의 필터 캐시가 메모리를 제어하고 쿼리 캐싱을 사용할지 여부는 elasticsearch.yml 파일에 옵션으로 추가하면 된다. 기본값은 true 이다.

### Shard request Cache
엘라스틱서치는 인덱스의 수평적 확산과 병렬 처리를 통한 서능 향상을 위해 고안된 캐시이다. 샤드는 데이터를 분산 저장하기 위한 단위로서, 그 자체가 온전한 기능을 가진 독립적인 인덱스라고 할 수 있다. Shard request Cache는 바로 이 샤드에서 수행된 쿼리의 결과를 캐싱한다. 샤드의 내용이 변경되면 캐시가 삭제되기 때문에 업데이트가 빈번한 인덱스에서는 성능 저하를 일으킬 수 있다.

### Field data Cache
엘라스틱서치가 필드에서 집계 연산을 수행할 때는 모든 필드 값을 메모리에 로드한다. 이러한 이유로 엘라스틱서치에서 계산되는 집계 쿼리는 성능적인 측면에서 비용이 많이 든다. Field data Cache는 집계가 계산된느 동안 필드의 값을 메모리에 보관한다.
 